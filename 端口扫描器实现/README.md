# 实验四：端口扫描器

## 一、实验目标

端口扫描器是一种重要的网络安全检测工具。通过端口扫描，不仅可以发现目标主机的开放端口和操作系统的类型，还可以查找系统的安全漏洞，获得弱口令等相关信息。因此，端口扫描技术是网络安全的基本技术之一，对于维护系统的安全性有着十分重要的意义。

编程训练的目的如下：

1. 掌握端口扫描器的基本设计方法。
2. 理解 ping 程序，TCP connect 扫描，TCP SYN 扫描，TCP FIN 扫描以及 UDP 扫描的工作原理。
3. 熟练掌握 Linux 环境下的套接字编程技术。
4. 掌握 Linux 环境下多线程编程的基本方法。

要求如下：

1. 编写端口扫描程序，提供 TCP connect 扫描，TCP SYN 扫描，TCP FIN 扫描以及 UDP 扫描四种基本扫描方式。
2. 设计并实现 ping 程序，探测目标主机是否可达。

## 二、实验内容

在 Linux 环境下编写一个端口扫描器，利用套接字（socket）正确实现 ping 程序、TCP connect 扫描、TCP SYN 扫描、TCP FIN 扫描、以及 UDP 扫描。

- ping 程序在用户输入被扫描主机 IP 地址之后探测该主机是否可达。
- 其它四种扫描在指定被扫描主机 IP，起始端口以及终止端口之后，从起始端口到终止端口对被测主机进行扫描，并将每一个端口的扫描结果正确地显示出来。

## 三、实验步骤及实验结果

### 1. 端口扫描器头文件

为使端口扫描器功能模块化、可复用，定义了一个头文件用于声明必要的数据结构和函数声明：

#### 结构体

- IPHeader：定义了IP头部的结构体，用于构造IP数据包。
- TCPHeader：定义了TCP头部的结构体，用于构造TCP数据包。
- pseudohdr：定义了TCP伪头部的结构体，用于计算TCP校验和。
- 各扫描线程参数的结构体。

#### 函数声明

- Ping：用于发送ICMP报文对指定主机进行探测，检查主机的存活性。
- 各模块扫描线程函数。

#### 辅助函数

- in_cksum：用于计算校验和的辅助函数。
- GetLocalHostIP：用于获取本地主机的IP地址。

### 2. ICMP探测指定主机

#### Ping程序流程

1. 创建ICMP套接字。
2. 创建ICMP数据包并填充。
3. 向目标主机发送ICMP报文。
4. 判断目标主机是否可达。

### 3. TCP connect扫描

#### 流程

1. 创建流套接字。
2. 设置连接目标主机的套接字地址。
3. 调用 connect 函数连接目标主机。
4. 通过子线程并行扫描多个端口。

### 4. TCP SYN 扫描

#### 流程

1. 创建套接字。
2. 填充报文信息。
3. 发送数据包。
4. 解析响应数据包。

### 5. TCP FIN 扫描

#### 流程

与 TCP SYN 扫描类似，但将 TCP 头 flags 字段的 FIN 位置 1。

### 6. UDP 扫描

#### 流程

1. 创建原始套接字。
2. 设置套接字选项。
3. 填充并发送UDP数据包。
4. 接收并解析ICMP响应数据包。

### 7. 根据程序输入格式实现端口扫描器

#### 功能

- print_h：打印帮助信息。
- print_c：TCP connect 扫描。
- 其它扫描方式类似。


